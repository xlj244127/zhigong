<template>
    <div class="box">
        <div class="list-block accordion-list">
            <!--<label>-->
                <!--<div class="all" @click="allSelect">-->
                    <!--<input type="checkbox"/>所有人员-->
                <!--</div>-->
            <!--</label>-->
            <ul class="aul">
                <li class="accordion-item" v-for="item in departmentAdmins">
                    <a href="#" class="item-content item-link">
                        <div class="item-inner">
                            <div class="tov">
                                <input type="checkbox" name="net" :data-id="item.id" :data-ischeck="item.isCheck" />
                                <div @click.stop.prevent="departmentSelect(item.id)" v-if="item.id==0">暂无部门</div>
                                <div @click.stop.prevent="departmentSelect(item.id)" v-else>{{item.name}}</div>
                            </div>
                        </div>
                    </a>
                    <div class="accordion-item-content">
                        <div class="content-block">
                            <label class="label-checkbox item-content" v-for="one in item.list">
                                <div class="item-inner">
                                    <div class="item-title">
                                        <div class="top">
                                            <div class="a2"><img :src="one.avatar"/></div>
                                            <div class="a3">
                                                <div class="left">
                                                    <span class="a3-1">{{(one.user_name?one.user_name:one.nickname)?(one.user_name?one.user_name:one.nickname):one.mobile}}</span>
                                                    <br/>
                                                    <span class="a3-2">{{one.mobile}}</span>&nbsp;  &nbsp;&nbsp;
                                                    <span class="a3-3">{{one.positions_name}}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <input type="checkbox" class="put" name="put" :data-id="item.id" :data-userId="one.user_id" :data-depId="one.department_id" :data-posId="one.positions_id" :data-ischeck="one.ischeck" />
                                <div class="item-media">
                                    <i class="icon icon-form-checkbox"></i>
                                </div>
                            </label>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
        <div class="title">
            <span>提示：如适用多个项目，请在选择某一项目并选择该项目适用详情后，点击保存，再选择其他项目进行编辑</span>
        </div>
        <div class="footer" @click="comfigAction">保存</div>
    </div>
</template>

<script>
    var $$ = Dom7;
    import { rightsApi, dutyApi } from '../../api';
    export default {
        name: "AccordingDepartent",
        data(){
            return{
                checked: true,
                companyId: '',
                departmentAdmins: [],
                userDutyListStr: [],
                selectedPerson: [],
                dutyRuleId: '',
                arr2: []
            }
        },
        props: ['status'],    //判断是创建(0)还是编辑(1)
        methods:{
            allSelect(){
                this.checked = !this.checked;
                if(this.checked) {
                    $$("input[name=net]").each(function() {
                        $$(this).prop("checked", false);
                    });
                    $$("input[name=put]").each(function() {
                        $$(this).prop("checked", false);
                    });
                }else{
                    $$("input[name=net]").each(function() {
                        $$(this).prop("checked", true);
                    });
                    $$("input[name=put]").each(function() {
                        $$(this).prop("checked", true);
                    });
                }
            },
            departmentSelect(param){
                console.log('点击了');
                this.checked = !this.checked;
                if(this.checked) {
                    $$("input[name=net]").each(function() {
                        if($$(this).data('id')==param){
                            $$(this).prop("checked", false);
                        }
                    });
                    $$("input[name=put]").each(function() {
                        if($$(this).data('id')==param){
                            $$(this).prop("checked", false);
                        }
                    });
                }else{
                    $$("input[name=net]").each(function() {
                        if($$(this).data('id')==param){
                            $$(this).prop("checked", true);
                        }
                    });
                    $$("input[name=put]").each(function() {
                        if($$(this).data('id')==param){
                            $$(this).prop("checked", true);
                        }
                    });
                }
            },
            common2(){
                this.userDutyListStr = [];
                let list = [];
                $$("input[name=put]").each((xls, elm)=>{
                    if($$(elm).prop("checked")){
                        let obj = {
                            userId: $$(elm).data('userId'),
                            departmentId: $$(elm).data('depId'),
                            positionsId: $$(elm).data('posId'),
                            usedType: 0,
                            companyId: this.companyId
                        }
                        list.push(obj);
                    }
                });
                this.userDutyListStr.push({
                    'id': 0,
                    'list': list,
                    'name': ''
                });

                if(this.$store.state.userDutyListStr.length!=0){
                    this.arr2 = [];
                    this.$store.state.userDutyListStr.map((res)=>{
                        this.arr2.push(res.id);
                    })
                }
            },
            comfigAction(){
                this.common2();
                if(this.$store.state.userDutyListStr.length!=0){
                    if(this.arr2.indexOf(0) == -1){
                        console.log('进入one');
                        this.$store.state.userDutyListStr = this.$store.state.userDutyListStr.concat(this.userDutyListStr);
                    }else{
                        this.$store.state.userDutyListStr.map((res)=>{
                            if(res.id == 0){
                                console.log('进入two');
                                res.list = this.userDutyListStr[0].list;
                            }
                        })
                    }
                }else{
                    this.$store.state.userDutyListStr = this.userDutyListStr;
                }

                console.log('按部门筛选的人',this.$store.state.userDutyListStr);
                this.$emit('modelAction');
            }
        },
        created(){
            this.companyId = this.$store.state.roleInfo.companyId;
            this.dutyRuleId = this.$store.state.dutyRuleId;
            dutyApi.accordDepartentGetRange(this.companyId, this.dutyRuleId).then((res)=>{
                console.log('部门人数',res.data);
                this.departmentAdmins = res.data;
                // if(this.status==1){
                    this.$nextTick(()=>{
                        if(this.$store.state.userDutyListStr.length!=0) {
                            this.$store.state.userDutyListStr.map((res) => {
                                if (res.id == 0) {
                                    res.list.map((one)=>{
                                        $$("input[name=put]").each((xls, elm)=>{
                                            if($$(elm).data('userId')==one.userId){
                                                $$(elm).attr('checked',true);
                                            }
                                        })
                                        $$("input[name=net]").attr('checked',true);
                                        // $$("input[name=net]").each((xls2, elm2)=>{
                                        //     if($$(elm2).data('id')==one.workGroupId){
                                        //         $$(elm2).attr('checked',true);
                                        //     }
                                        // })
                                    })
                                }
                            })
                        }
                        // console.log('调用了');
                        // $$("input[name=put]").each((xls, elm)=>{
                        //     if($$(elm).data('ischeck')==1){
                        //         $$(elm).attr('checked',true);
                        //     }
                        // })
                        // $$("input[name=net]").each((xls2, elm2)=>{
                        //     if($$(elm2).data('ischeck')==1){
                        //         $$(elm2).attr('checked',true);
                        //     }
                        // })
                    })
                // }
            })
        },
        mounted(){

        }
    }
</script>

<style scoped>
    .box{
        margin-bottom: 3rem;
    }
    .list-block .item-content{
        padding: 0;
    }
    .list-block .all{
        width: 100%; height: 2rem; line-height: 2rem; box-sizing: border-box; padding-left: 0.6rem; background: #fff; color: #666;
    }
    .list-block .item-inner{
        display: flex; margin: 0; padding: 0;

    }
    .list-block .item-title{
        width: 100%;
    }
    .list-block .item-inner .tov{
        height: 2.2rem; line-height: 2.2rem; padding-left: 0.6rem; position: relative;
    }
    .list-block .item-inner .tov input{
        position: absolute; left: 0.8rem; top: 16px;
    }
    .list-block .item-inner .tov div{
        box-sizing: border-box; padding-left: 1rem;
    }

    .list-block{
        margin: 0; font-size: 0.7rem; color: #666;
    }
    .list-block ul{
        background: #f4f4f4;
    }
    .list-block li{
        margin-bottom: 5px; background: #fff;
    }
    .top{
        display: flex; width: 100%; height: 65px; border-top: 1px solid #f4f4f4;
    }
    .top .a2{
        width: 2rem; height: 2rem; border: 1px solid #000; border-radius: 50%; margin-top: 0.5rem; margin-left: 50px;
    }
    .top .a2 img{
        width: 2rem; height: 2rem; border-radius: 50%;
    }
    .top .a3{
        padding: 0.7rem 0 0 0.8rem; flex: 1; overflow: hidden; position: relative;
    }
    .top .a3 .left .a3-1{
        font-size: 0.8rem; color: #438cff;
    }
    .top .a3 .left .a3-2{
        font-size: 0.6rem; color: #999;
    }
    .top .a3 .left .a3-3{
        font-size: 0.6rem; color: #438CFF;
    }

    .form-checkbox i, label.label-checkbox i.icon-form-checkbox{
        width: 16px; height: 16px; position: absolute; left: 24px;
    }

    .title{
        width: 100%; box-sizing: border-box; padding: 0 12px; font-size: 0.55rem; color: #AAAAAA; text-align: center; margin-top: 0.7rem;
        margin-bottom: 6rem;
    }
    .footer{
        width: 108px; height: 2rem; line-height: 2rem; text-align: center; font-size: 0.8rem; color: #fff; background: #438CFF;
        position: fixed; left: 36%; bottom: 28px; border-radius: 2.5px;
    }
</style>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    